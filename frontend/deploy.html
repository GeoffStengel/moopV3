<!DOCTYPE html>
<html>
<head>
  <title>MoopV3 Contract Deployment</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #output { white-space: pre-wrap; margin-top: 20px; }
    button { padding: 10px 20px; font-size: 16px; margin-right: 10px; margin-bottom: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 8px; font-size: 14px; }
    .error { color: red; }
    .success { color: green; }
    select { padding: 8px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Deploy MoopV3 Contracts</h1>
  <div class="form-group">
    <label>Select Network</label>
    <select id="networkSelect" onchange="switchNetwork()">
      <option value="11155111">Sepolia</option>
      <option value="1">Mainnet</option>
    </select>
  </div>
  <div class="form-group">
    <label>WETH9 Address (Sepolia: 0xa904DA07A28BBa468497042f0b2D581487857971)</label>
    <input type="text" id="weth9Address" placeholder="Enter existing WETH9 address or leave blank to deploy" />
  </div>
  <button onclick="deployLibraries()">Deploy Libraries</button>
  <button onclick="deployUniswapV3Factory()">Deploy UniswapV3Factory</button>
  <button onclick="deployTokenMinter()">Deploy TokenMinter</button>
  <button onclick="deployUniswapV3PoolDeployer()">Deploy UniswapV3PoolDeployer</button>
  <button onclick="deployNonfungibleTokenPositionDescriptor()">Deploy NonfungibleTokenPositionDescriptor</button>
  <button onclick="deployNonfungiblePositionManager()">Deploy NonfungiblePositionManager</button>
  <button onclick="deploySwapRouter()">Deploy SwapRouter</button>
  <p id="output"></p>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script>
    let deployedAddresses = JSON.parse(localStorage.getItem('moopV3Artifacts')) || {};
    const SEPOLIA_WETH9 = '0xa904DA07A28BBa468497042f0b2D581487857971';
    const MAINNET_WETH9 = '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2';
    const FEE_TO = '0xc4042DfAbF63F9d32849ca257b1EE1699a21a134';

    async function saveArtifacts() {
      try {
        localStorage.setItem('moopV3Artifacts', JSON.stringify(deployedAddresses));
        const blob = new Blob([JSON.stringify(deployedAddresses, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `deployedArtifacts_${new Date().toISOString()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById('output').innerText += `\n📝 Artifacts saved to localStorage and downloaded as deployedArtifacts_${new Date().toISOString()}.json 🎉\n`;
      } catch (error) {
        document.getElementById('output').innerText += `\n❌ Error saving artifacts: ${error.message}\n`;
      }
    }

    async function fetchArtifact(contractName, path = '') {
      try {
        const url = path ? `/artifacts/contracts/${path}/${contractName}.sol/${contractName}.json` : `/artifacts/contracts/minter_contracts/${contractName}.sol/${contractName}.json`;
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Failed to fetch ${contractName} artifact: Status ${response.status}`);
        }
        const artifact = await response.json();
        if (!artifact.abi || !artifact.bytecode) {
          throw new Error(`Invalid artifact for ${contractName}: Missing abi or bytecode`);
        }
        return { abi: artifact.abi, bytecode: artifact.bytecode };
      } catch (error) {
        throw new Error(`Error fetching ${contractName} artifact: ${error.message}`);
      }
    }

    async function switchNetwork() {
      const networkSelect = document.getElementById('networkSelect').value;
      const chainId = networkSelect === '1' ? '0x1' : '0xaa36a7';
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId }],
        });
        document.getElementById('output').innerText += `🌐 Switched to ${networkSelect === '1' ? 'Mainnet' : 'Sepolia'} network 🎉\n`;
        document.getElementById('weth9Address').value = networkSelect === '11155111' ? SEPOLIA_WETH9 : MAINNET_WETH9;
      } catch (error) {
        document.getElementById('output').innerText += `\n❌ Error switching network: ${error.message}\n`;
      }
    }

    async function checkWallet() {
      const output = document.getElementById('output');
      if (!window.ethereum) {
        output.innerText = '⚠️ Please install MetaMask!';
        throw new Error('MetaMask not installed');
      }

      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const address = await signer.getAddress();
      output.innerText += `👤 Connected: ${address}\n`;

      const balance = await provider.getBalance(address);
      output.innerText += `💰 Account balance: ${ethers.utils.formatEther(balance)} ETH\n`;
      if (balance.isZero()) {
        output.innerText += `❌ Error: Account has 0 ETH. Please fund it with ${document.getElementById('networkSelect').value === '1' ? 'Mainnet' : 'Sepolia'} ETH.\n`;
        throw new Error('Account has 0 ETH');
      }

      return { provider, signer };
    }

    async function deployLibraries() {
      const output = document.getElementById('output');
      try {
        const { provider, signer } = await checkWallet();
        const libraryContracts = [
          'ChainId', 'TickMath', 'SqrtPriceMath', 'FullMath', 'SwapMath',
          'Tick', 'Position', 'Oracle', 'HexStrings', 'SVGUtils'
        ];

        for (const contractName of libraryContracts) {
          if (deployedAddresses[contractName]) {
            output.innerText += `📚 ${contractName} already deployed at: ${deployedAddresses[contractName]} ✅\n`;
            continue;
          }
          output.innerText += `📚 Fetching artifact for ${contractName}... 🔎\n`;
          const artifact = await fetchArtifact(contractName, 'uniswap/libraries');
          let factory;
          if (contractName === 'SVGUtils') {
            factory = new ethers.ContractFactory(artifact.abi, artifact.bytecode, signer).connect(signer);
            output.innerText += `🚀 Deploying ${contractName} with HexStrings library at ${deployedAddresses.HexStrings}...\n`;
            const contract = await factory.deploy(deployedAddresses.HexStrings, { gasLimit: 5000000 });
            await contract.deployed();
            output.innerText += `🎉 ${contractName} deployed to: ${contract.address}\n`;
            deployedAddresses[contractName] = contract.address;
            deployedAddresses[`${contractName}_abi`] = artifact.abi;
          } else {
            factory = new ethers.ContractFactory(artifact.abi, artifact.bytecode, signer);
            output.innerText += `🚀 Deploying ${contractName} library...\n`;
            const contract = await factory.deploy({ gasLimit: 5000000 });
            await contract.deployed();
            output.innerText += `🎉 ${contractName} deployed to: ${contract.address}\n`;
            deployedAddresses[contractName] = contract.address;
            deployedAddresses[`${contractName}_abi`] = artifact.abi;
          }
          await saveArtifacts();
        }
        output.innerText += `\n🎉 Libraries deployment complete! 🥳\n`;
      } catch (error) {
        console.error(error);
        output.innerText += `\n❌ Error: ${error.message}\n`;
      }
    }

    async function deployUniswapV3Factory() {
      const output = document.getElementById('output');
      try {
        if (deployedAddresses.UniswapV3Factory) {
          output.innerText += `📚 UniswapV3Factory already deployed at: ${deployedAddresses.UniswapV3Factory} ✅\n`;
          return;
        }
        const { provider, signer } = await checkWallet();
        const feeTo = FEE_TO;
        output.innerText += `📚 Fetching artifact for UniswapV3Factory... 🔎\n`;
        const { abi, bytecode } = await fetchArtifact('UniswapV3Factory', 'uniswap');
        const factory = new ethers.ContractFactory(abi, bytecode, signer);
        output.innerText += `🚀 Deploying UniswapV3Factory with feeTo: ${feeTo}...\n`;
        const contract = await factory.deploy(feeTo, { gasLimit: 5000000 });
        await contract.deployed();
        output.innerText += `🎉 UniswapV3Factory deployed to: ${contract.address}\n`;
        deployedAddresses.UniswapV3Factory = contract.address;
        deployedAddresses.UniswapV3Factory_abi = abi;
        await saveArtifacts();
      } catch (error) {
        console.error(error);
        output.innerText += `\n❌ Error: ${error.message}\n`;
      }
    }

    async function deployTokenMinter() {
      const output = document.getElementById('output');
      try {
        if (deployedAddresses.TokenMinter) {
          output.innerText += `📚 TokenMinter already deployed at: ${deployedAddresses.TokenMinter} ✅\n`;
          return;
        }
        const { provider, signer } = await checkWallet();
        output.innerText += `📚 Fetching artifact for TokenMinter... 🔎\n`;
        const { abi, bytecode } = await fetchArtifact('TokenMinter', 'minter_contracts');
        const factory = new ethers.ContractFactory(abi, bytecode, signer);
        output.innerText += `🚀 Deploying TokenMinter...\n`;
        const contract = await factory.deploy({ gasLimit: 5000000 });
        await contract.deployed();
        output.innerText += `🎉 TokenMinter deployed to: ${contract.address}\n`;
        deployedAddresses.TokenMinter = contract.address;
        deployedAddresses.TokenMinter_abi = abi;
        await saveArtifacts();
      } catch (error) {
        console.error(error);
        output.innerText += `\n❌ Error: ${error.message}\n`;
      }
    }

    async function deployUniswapV3PoolDeployer() {
      const output = document.getElementById('output');
      try {
        if (deployedAddresses.UniswapV3PoolDeployer) {
          output.innerText += `📚 UniswapV3PoolDeployer already deployed at: ${deployedAddresses.UniswapV3PoolDeployer} ✅\n`;
          return;
        }
        const { provider, signer } = await checkWallet();
        output.innerText += `📚 Fetching artifact for UniswapV3PoolDeployer... 🔎\n`;
        const { abi, bytecode } = await fetchArtifact('UniswapV3PoolDeployer', 'uniswap');
        const factory = new ethers.ContractFactory(abi, bytecode, signer);
        output.innerText += `🚀 Deploying UniswapV3PoolDeployer...\n`;
        const contract = await factory.deploy({ gasLimit: 5000000 });
        await contract.deployed();
        output.innerText += `🎉 UniswapV3PoolDeployer deployed to: ${contract.address}\n`;
        deployedAddresses.UniswapV3PoolDeployer = contract.address;
        deployedAddresses.UniswapV3PoolDeployer_abi = abi;
        await saveArtifacts();
      } catch (error) {
        console.error(error);
        output.innerText += `\n❌ Error: ${error.message}\n`;
      }
    }

    async function deployNonfungibleTokenPositionDescriptor() {
      const output = document.getElementById('output');
      try {
        if (deployedAddresses.NonfungibleTokenPositionDescriptor) {
          output.innerText += `📚 NonfungibleTokenPositionDescriptor already deployed at: ${deployedAddresses.NonfungibleTokenPositionDescriptor} ✅\n`;
          return;
        }
        const weth9Input = document.getElementById('weth9Address').value || (document.getElementById('networkSelect').value === '11155111' ? SEPOLIA_WETH9 : MAINNET_WETH9);
        if (!ethers.utils.isAddress(weth9Input)) {
          output.innerText += `❌ Error: Invalid WETH9 address provided.\n`;
          return;
        }
        deployedAddresses.WETH9 = weth9Input;
        if (!deployedAddresses.NFTDescriptor) {
          output.innerText += `❌ Error: NFTDescriptor must be deployed first.\n`;
          return;
        }
        const { provider, signer } = await checkWallet();
        output.innerText += `📚 Fetching artifact for NonfungibleTokenPositionDescriptor... 🔎\n`;
        const { abi, bytecode } = await fetchArtifact('NonfungibleTokenPositionDescriptor', 'uniswap');
        const factory = new ethers.ContractFactory(abi, bytecode, signer);
        output.innerText += `🚀 Deploying NonfungibleTokenPositionDescriptor...\n`;
        const contract = await factory.deploy(
          deployedAddresses.WETH9,
          ethers.utils.formatBytes32String("ETH"),
          { gasLimit: 7000000 }
        );
        await contract.deployed();
        output.innerText += `🎉 NonfungibleTokenPositionDescriptor deployed to: ${contract.address}\n`;
        deployedAddresses.NonfungibleTokenPositionDescriptor = contract.address;
        deployedAddresses.NonfungibleTokenPositionDescriptor_abi = abi;
        await saveArtifacts();
      } catch (error) {
        console.error(error);
        output.innerText += `\n❌ Error: ${error.message}\n`;
      }
    }

    async function deployNonfungiblePositionManager() {
      const output = document.getElementById('output');
      try {
        if (deployedAddresses.NonfungiblePositionManager) {
          output.innerText += `📚 NonfungiblePositionManager already deployed at: ${deployedAddresses.NonfungiblePositionManager} ✅\n`;
          return;
        }
        const weth9Input = document.getElementById('weth9Address').value || (document.getElementById('networkSelect').value === '11155111' ? SEPOLIA_WETH9 : MAINNET_WETH9);
        if (!ethers.utils.isAddress(weth9Input)) {
          output.innerText += `❌ Error: Invalid WETH9 address provided.\n`;
          return;
        }
        deployedAddresses.WETH9 = weth9Input;
        if (!deployedAddresses.UniswapV3Factory || !deployedAddresses.UniswapV3PoolDeployer || !deployedAddresses.NonfungibleTokenPositionDescriptor) {
          output.innerText += `❌ Error: UniswapV3Factory, UniswapV3PoolDeployer, and NonfungibleTokenPositionDescriptor must be deployed first.\n`;
          return;
        }
        const { provider, signer } = await checkWallet();
        output.innerText += `📚 Fetching artifact for NonfungiblePositionManager... 🔎\n`;
        const { abi, bytecode } = await fetchArtifact('NonfungiblePositionManager', 'uniswap');
        const factory = new ethers.ContractFactory(abi, bytecode, signer);
        output.innerText += `🚀 Deploying NonfungiblePositionManager...\n`;
        const contract = await factory.deploy(
          deployedAddresses.UniswapV3Factory,
          deployedAddresses.UniswapV3PoolDeployer,
          deployedAddresses.NonfungibleTokenPositionDescriptor,
          { gasLimit: 7000000 }
        );
        await contract.deployed();
        output.innerText += `🎉 NonfungiblePositionManager deployed to: ${contract.address}\n`;
        deployedAddresses.NonfungiblePositionManager = contract.address;
        deployedAddresses.NonfungiblePositionManager_abi = abi;
        await saveArtifacts();
      } catch (error) {
        console.error(error);
        output.innerText += `\n❌ Error: ${error.message}\n`;
      }
    }

    async function deploySwapRouter() {
      const output = document.getElementById('output');
      try {
        if (deployedAddresses.SwapRouter) {
          output.innerText += `📚 SwapRouter already deployed at: ${deployedAddresses.SwapRouter} ✅\n`;
          return;
        }
        const weth9Input = document.getElementById('weth9Address').value || (document.getElementById('networkSelect').value === '11155111' ? SEPOLIA_WETH9 : MAINNET_WETH9);
        if (!ethers.utils.isAddress(weth9Input)) {
          output.innerText += `❌ Error: Invalid WETH9 address provided.\n`;
          return;
        }
        deployedAddresses.WETH9 = weth9Input;
        if (!deployedAddresses.UniswapV3Factory) {
          output.innerText += `❌ Error: UniswapV3Factory must be deployed first.\n`;
          return;
        }
        const { provider, signer } = await checkWallet();
        output.innerText += `📚 Fetching artifact for SwapRouter... 🔎\n`;
        const { abi, bytecode } = await fetchArtifact('SwapRouter', 'uniswap');
        const factory = new ethers.ContractFactory(abi, bytecode, signer);
        output.innerText += `🚀 Deploying SwapRouter...\n`;
        const contract = await factory.deploy(
          deployedAddresses.UniswapV3Factory,
          deployedAddresses.WETH9,
          { gasLimit: 5000000 }
        );
        await contract.deployed();
        output.innerText += `🎉 SwapRouter deployed to: ${contract.address}\n`;
        deployedAddresses.SwapRouter = contract.address;
        deployedAddresses.SwapRouter_abi = abi;
        await saveArtifacts();
      } catch (error) {
        console.error(error);
        output.innerText += `\n❌ Error: ${error.message}\n`;
      }
    }
  </script>
</body>
</html>